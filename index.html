<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Eurojackpot Analyse & Varianten-Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Fallback: JSZip; zus√§tzlich wird im Code bei Bedarf dynamisch nachgeladen -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    :root{
      --bg:#020617;--bg2:#0b1120;--card:#020617;
      --border:#1f2937;--accent:#3b82f6;--accent-soft:rgba(59,130,246,.15);
      --txt:#e5e7eb;--muted:#9ca3af;--soft:#6b7280;
      --danger:#ef4444;--ok:#22c55e;--warn:#facc15;
      --r-lg:18px;--r-md:12px;--r-pill:999px;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;padding:0;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,sans-serif;
      background:radial-gradient(circle at top,#111827 0,#020617 50%,#000 100%);
      color:var(--txt);-webkit-font-smoothing:antialiased
    }
    body{min-height:100vh;display:flex;align-items:stretch;justify-content:center;padding:12px}
    .shell{
      max-width:1200px;width:100%;border-radius:24px;
      background:linear-gradient(135deg,#020617,#020617);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 24px 60px rgba(0,0,0,.7);
      display:flex;flex-direction:column;overflow:hidden
    }
    header{
      padding:16px 20px;border-bottom:1px solid rgba(31,41,55,.9);
      display:flex;gap:12px;justify-content:space-between;align-items:center;
      background:radial-gradient(circle at 0 0,rgba(59,130,246,.5),transparent 60%)
    }
    .logo{
      width:34px;height:34px;border-radius:50%;
      background:radial-gradient(circle at 30% 20%,#f9fafb,#60a5fa);
      display:flex;align-items:center;justify-content:center;
      color:#020617;font-weight:800;
      box-shadow:0 0 0 1px rgba(15,23,42,.9),0 10px 25px rgba(15,23,42,.9)
    }
    .title h1{
      margin:0;font-size:18px;letter-spacing:.07em;text-transform:uppercase;
      display:flex;align-items:center;gap:8px
    }
    .badge{
      font-size:11px;padding:3px 8px;border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      background:rgba(15,23,42,.9);color:var(--muted)
    }
    .title small{display:block;font-size:12px;color:var(--soft);margin-top:2px}
    .pill-info{
      font-size:11px;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(148,163,184,.5);
      display:flex;align-items:center;gap:6px;background:rgba(15,23,42,.95)
    }
    .pill-dot{
      width:7px;height:7px;border-radius:50%;
      background:var(--ok);box-shadow:0 0 0 4px rgba(34,197,94,.25)
    }
    .btn{
      border:none;border-radius:999px;padding:7px 14px;
      font-size:13px;font-weight:500;cursor:pointer;
      display:inline-flex;align-items:center;gap:6px;
      background:radial-gradient(circle at 0 0,#fff,#93c5fd);
      color:#020617;
      box-shadow:0 10px 25px rgba(37,99,235,.7),0 0 0 1px rgba(191,219,254,.8);
      transition:.15s
    }
    .btn-sm{padding:5px 12px;font-size:12px}
    .btn-outline{
      background:rgba(15,23,42,.96);color:var(--muted);
      box-shadow:none;border:1px solid rgba(148,163,184,.5)
    }
    .btn-outline:hover{background:#020617;color:var(--txt)}
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 14px 30px rgba(37,99,235,.85),0 0 0 1px rgba(219,234,254,.9)
    }
    .btn:active{transform:translateY(0);box-shadow:0 8px 18px rgba(30,64,175,.9)}
    main{
      display:grid;grid-template-columns:260px minmax(0,1fr);
      gap:14px;padding:14px 16px 16px
    }
    aside{border-right:1px solid rgba(31,41,55,.9);padding-right:12px;margin-right:-4px}
    .card{
      background:linear-gradient(135deg,#020617,#020617);
      border-radius:var(--r-lg);
      border:1px solid rgba(31,41,55,.95);
      box-shadow:0 18px 40px rgba(0,0,0,.75);
      padding:12px 12px 14px
    }
    .card h2{
      margin:0 0 6px;font-size:14px;text-transform:uppercase;
      letter-spacing:.08em;color:#e5e7eb
    }
    .card p{margin:0;font-size:12px;color:var(--soft)}
    .note{font-size:11px;margin-top:6px;color:var(--muted)}
    .risk{
      margin-top:10px;font-size:11px;padding:7px 8px;
      border-radius:var(--r-md);border:1px dashed rgba(248,250,252,.3);
      background:linear-gradient(135deg,rgba(127,29,29,.8),rgba(15,23,42,.95));
      color:#fef9c3
    }
    .grid-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .card-header{
      display:flex;justify-content:space-between;
      align-items:flex-start;gap:8px;margin-bottom:6px
    }
    .chip{
      font-size:11px;padding:3px 7px;border-radius:999px;
      border:1px solid rgba(75,85,99,.9);
      background:rgba(15,23,42,.9);color:var(--muted)
    }
    .sub{font-size:11px;color:var(--soft)}
    .row{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px}
    .group{flex:1;min-width:0;display:flex;flex-direction:column;gap:4px}
    label{font-size:11px;color:var(--soft)}
    input[type="number"],input[type="date"],input[type="file"],select,textarea{
      background:#020617;border-radius:var(--r-md);
      border:1px solid rgba(55,65,81,.95);color:var(--txt);
      font-size:12px;padding:6px 8px;outline:none;transition:.16s
    }
    input:focus,select:focus,textarea:focus{
      border-color:var(--accent);box-shadow:0 0 0 1px rgba(59,130,246,.7)
    }
    textarea{min-height:100px;resize:vertical}
    .switch{
      display:inline-flex;align-items:center;gap:6px;
      font-size:11px;color:var(--soft);cursor:pointer
    }
    .switch input{display:none}
    .sw-pill{
      width:28px;height:16px;border-radius:999px;
      background:#020617;border:1px solid rgba(75,85,99,.9);position:relative
    }
    .sw-thumb{
      width:12px;height:12px;border-radius:50%;
      background:#e5e7eb;position:absolute;top:1px;left:1px;transition:.16s
    }
    .switch input:checked + .sw-pill{
      background:linear-gradient(135deg,#93c5fd,#2563eb);
      border-color:rgba(191,219,254,.9)
    }
    .switch input:checked + .sw-pill .sw-thumb{
      transform:translateX(10px);background:#020617;
      box-shadow:0 0 0 3px rgba(191,219,254,.7)
    }
    .status{font-size:11px;color:var(--soft);margin-top:3px}
    .status .ok{color:var(--ok)}.status .err{color:var(--danger)}.status .warn{color:var(--warn)}
    .loader{
      width:14px;height:14px;border-radius:50%;
      border:2px solid rgba(148,163,184,.6);border-top-color:#e5e7eb;
      display:inline-block;animation:spin .7s linear infinite;margin-right:4px
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    table{width:100%;border-collapse:collapse;font-size:11px;color:var(--muted)}
    th,td{
      padding:5px 7px;border-bottom:1px solid rgba(31,41,55,.9);
      white-space:nowrap;text-align:left
    }
    thead{background:#020617;position:sticky;top:0;z-index:1}
    .tbl-wrap{
      margin-top:6px;max-height:230px;overflow:auto;
      border-radius:12px;border:1px solid rgba(31,41,55,.95);
      background:#020617
    }
    .balls{display:flex;flex-wrap:wrap;gap:3px}
    .ball{
      min-width:20px;height:20px;border-radius:999px;
      background:radial-gradient(circle at 30% 20%,#f9fafb,#9ca3af);
      color:#020617;font-size:11px;display:flex;
      align-items:center;justify-content:center;
      border:1px solid rgba(148,163,184,.8)
    }
    .ball.euro{
      background:radial-gradient(circle at 30% 20%,#fef9c3,#fbbf24);
      border-color:rgba(234,179,8,.9)
    }
    .pill-mini{
      border-radius:999px;padding:2px 6px;
      border:1px solid rgba(75,85,99,.9);font-size:10px
    }
    .hot{background:rgba(127,29,29,.7);border-color:rgba(248,113,113,.9);color:#fee2e2}
    .cold{background:rgba(30,64,175,.7);border-color:rgba(59,130,246,.9);color:#dbeafe}
    footer{
      padding:8px 14px 10px;border-top:1px solid rgba(31,41,55,.95);
      display:flex;justify-content:space-between;gap:8px;
      font-size:11px;color:var(--soft)
    }
    .fbadge{
      padding:3px 8px;border-radius:999px;
      border:1px solid rgba(75,85,99,.9);
      background:#020617;color:var(--muted)
    }
    .link{
      color:#bfdbfe;text-decoration:none;
      border-bottom:1px dashed rgba(191,219,254,.6)
    }
    .link:hover{border-bottom-style:solid}
    @media(max-width:950px){
      main{grid-template-columns:minmax(0,1fr);padding:12px}
      aside{border-right:none;border-bottom:1px solid rgba(31,41,55,.9);padding-bottom:10px;margin-right:0}
    }
    @media(max-width:650px){
      header{flex-direction:column;align-items:flex-start}
      footer{flex-direction:column}
      .grid-2{grid-template-columns:minmax(0,1fr)}
    }
  </style>
</head>
<body>
<div class="shell">
  <header>
    <div style="display:flex;gap:12px;align-items:center">
      <div class="logo">EJ</div>
      <div class="title">
        <h1>Eurojackpot <span class="badge">Analyse &amp; Varianten-Tool</span></h1>
        <small>Archiv, Statistik &amp; Varianten ‚Äì alles lokal im Browser.</small>
      </div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <div class="pill-info"><span class="pill-dot"></span><span>Reine Statistik ‚Äì keine Gewinn-Garantie.</span></div>
      <button class="btn btn-sm" id="scrollGen"><span>üéüÔ∏è</span><span>Zum Generator</span></button>
    </div>
  </header>

  <main>
    <aside>
      <div class="card">
        <h2>Kurzanleitung</h2>
        <p>
          Dieses Tool l√§dt das Eurojackpot-Archiv direkt vom offiziellen Lotto-Bayern-URL
          (ZIP), versucht mehrere CORS-Proxys, entpackt die ZIP im Browser und
          analysiert die Ziehungen.
        </p>
        <div class="note">
          Wenn alle Proxys scheitern, bekommst du eine Fehlermeldung.
          Du kannst dann die ZIP oder TXT/CSV manuell herunterladen und hier laden.
        </div>
        <div class="risk">
          ‚ö†Ô∏è <strong>Wichtig:</strong> Jede Zahlenkombination ist mathematisch gleich wahrscheinlich.
          Die Auswertungen sind nur Statistik, keine Gewinn-Strategie.
        </div>
      </div>
    </aside>

    <section style="min-width:0">
      <div class="grid-2">
        <!-- ARCHIV -->
        <div class="card">
          <div class="card-header">
            <div>
              <h2>Archiv laden</h2>
              <div class="sub">ZIP von Lotto-Bayern, automatisch entpackt und eingelesen.</div>
            </div>
            <span class="chip">Quelle: Lotto-Bayern</span>
          </div>
          <div class="row">
            <div class="group">
              <label>Automatisch vom offiziellen Link</label>
              <button class="btn btn-sm" id="btnLoadRemote">üì• Archiv herunterladen &amp; entpacken</button>
              <div class="note">
                URL:<br>
                <code style="font-size:10px">https://www.lotto-bayern.de/static/gamebroker_2/de/download_files/archiv_eurojackpot.zip</code><br>
                Es werden nacheinander mehrere CORS-Proxys ausprobiert, bis eine Variante funktioniert.
              </div>
            </div>
          </div>
          <div class="row">
            <div class="group">
              <label>Datei manuell ausw√§hlen (ZIP / TXT / CSV)</label>
              <input id="fileInput" type="file" accept=".zip,.txt,.csv">
              <div class="note">
                Falls alle Proxys scheitern: ZIP von Lotto-Bayern herunterladen und hier ausw√§hlen ‚Äì 
                oder die entpackte TXT/CSV.
              </div>
            </div>
          </div>
          <div id="archiveStatus" class="status">Noch keine Daten geladen.</div>
        </div>

        <!-- STATISTIK -->
        <div class="card">
          <div class="card-header">
            <div>
              <h2>Statistik</h2>
              <div class="sub">Hot/Cold-Zahlen &amp; Bereichsquoten.</div>
            </div>
            <span class="chip">Frequenzanalyse</span>
          </div>
          <div class="row">
            <div class="group">
              <label>Zeitraum (letzte X Ziehungen)</label>
              <select id="statsRange">
                <option value="6">6</option>
                <option value="12" selected>12</option>
                <option value="18">18</option>
                <option value="24">24</option>
                <option value="30">30</option>
                <option value="36">36</option>
                <option value="42">42</option>
                <option value="48">48</option>
                <option value="54">54</option>
                <option value="60">60</option>
              </select>
            </div>
            <div class="group">
              <label>&nbsp;</label>
              <button class="btn btn-sm btn-outline" id="btnStats">Statistik berechnen</button>
            </div>
          </div>
          <div id="statsStatus" class="status">Bitte zuerst das Archiv laden.</div>
          <div class="tbl-wrap" id="statsTableWrap" style="display:none">
            <table>
              <thead><tr><th>Zahl</th><th>H√§ufigkeit</th><th>Quote</th><th>Hot/Cold</th></tr></thead>
              <tbody id="statsBody"></tbody>
            </table>
          </div>
          <div class="tbl-wrap" id="rangeTableWrap" style="display:none;margin-top:4px">
            <table>
              <thead><tr><th>Bereich</th><th>Anzahl</th><th>Quote</th></tr></thead>
              <tbody id="rangeBody"></tbody>
            </table>
          </div>
          <div class="note">Bereiche: 1‚Äì10, 11‚Äì20, 21‚Äì30, 31‚Äì40, 41‚Äì50.</div>
        </div>
      </div>

      <div class="grid-2" id="generatorSection" style="margin-top:14px">
        <!-- GENERATOR -->
        <div class="card">
          <div class="card-header">
            <div>
              <h2>Varianten-Generator</h2>
              <div class="sub">Diversifizierte Varianten mit Statistikgewichtung.</div>
            </div>
            <span class="chip">Smart-Generator</span>
          </div>
          <div class="row">
            <div class="group">
              <label>Anzahl Varianten (1‚Äì500)</label>
              <input type="number" id="numVariants" value="20" min="1" max="500">
            </div>
            <div class="group">
              <label>Ziehungsdatum (Info)</label>
              <input type="date" id="drawDate">
            </div>
          </div>
          <div class="row">
            <div class="group">
              <label>Optionen</label>
              <label class="switch">
                <input id="genIncludeEuro" type="checkbox" checked>
                <span class="sw-pill"><span class="sw-thumb"></span></span>
                <span>Eurozahlen generieren</span>
              </label>
              <label class="switch">
                <input id="genUseStats" type="checkbox" checked>
                <span class="sw-pill"><span class="sw-thumb"></span></span>
                <span>Hot/Cold &amp; Bereiche nutzen</span>
              </label>
            </div>
            <div class="group">
              <label>Diversit√§t</label>
              <label class="switch">
                <input id="genNoDup" type="checkbox" checked>
                <span class="sw-pill"><span class="sw-thumb"></span></span>
                <span>Duplikate verhindern</span>
              </label>
              <label class="switch">
                <input id="genMaxDiff" type="checkbox" checked>
                <span class="sw-pill"><span class="sw-thumb"></span></span>
                <span>Abstand zwischen Varianten maximieren</span>
              </label>
            </div>
          </div>
          <div class="row">
            <button class="btn btn-sm" id="btnGen">Varianten generieren</button>
            <div id="genStatus" class="status"></div>
          </div>
          <div class="tbl-wrap" id="genTableWrap" style="display:none">
            <table>
              <thead><tr><th>#</th><th>Hauptzahlen</th><th>Eurozahlen</th></tr></thead>
              <tbody id="genBody"></tbody>
            </table>
          </div>
          <div class="row" id="genExportRow" style="display:none;margin-top:6px">
            <button class="btn btn-sm btn-outline" id="btnExportTxt">Als TXT exportieren</button>
            <button class="btn btn-sm btn-outline" id="btnExportCsv">Als CSV exportieren</button>
          </div>
          <div class="note">Gewichtungen ver√§ndern die Auswahlverteilung, aber nicht die mathematische Ziehungswahrscheinlichkeit.</div>
        </div>

        <!-- ANALYSE -->
        <div class="card">
          <div class="card-header">
            <div>
              <h2>Varianten-Analyse</h2>
              <div class="sub">Pr√ºft Varianten gegen alle geladenen Ziehungen.</div>
            </div>
            <span class="chip">Historie</span>
          </div>
          <div class="row">
            <div class="group">
              <label>Quelle der Varianten</label>
              <label class="switch">
                <input type="radio" name="vsource" value="gen" checked>
                <span class="sw-pill"><span class="sw-thumb"></span></span>
                <span>aktuell generierte</span>
              </label>
              <label class="switch">
                <input type="radio" name="vsource" value="manual">
                <span class="sw-pill"><span class="sw-thumb"></span></span>
                <span>manuell eingegebene</span>
              </label>
            </div>
            <div class="group">
              <label>Analyse-Option</label>
              <label class="switch">
                <input id="analysisIncludeEuro" type="checkbox" checked>
                <span class="sw-pill"><span class="sw-thumb"></span></span>
                <span>Eurozahlen ber√ºcksichtigen</span>
              </label>
            </div>
          </div>
          <div class="row" id="manualRow" style="display:none">
            <div class="group">
              <label>Manuelle Varianten (eine pro Zeile)</label>
              <textarea id="manualInput" placeholder="Beispiel:
1 5 12 28 44 | 3 7
2;11;19;25;36;4;8"></textarea>
            </div>
          </div>
          <div class="row">
            <button class="btn btn-sm btn-outline" id="btnAnalyze">Analyse starten</button>
            <div id="analysisStatus" class="status"></div>
          </div>
          <div class="tbl-wrap" id="analysisWrap" style="display:none">
            <table>
              <thead>
                <tr>
                  <th>#</th><th>Variante</th><th>3/5</th><th>4/5</th><th>5/5</th><th>mit Euro (z.B. 5+2)</th>
                </tr>
              </thead>
              <tbody id="analysisBody"></tbody>
            </table>
          </div>
          <div class="note">Gez√§hlt werden alle Ziehungen, in denen eine Variante mindestens drei Hauptzahlen getroffen hat.</div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div><span class="fbadge">Mathematisch fair ¬∑ reine Statistik</span> <span>Bitte nur mit Geld spielen, dessen Verlust du verkraften kannst.</span></div>
    <div>Archiv-Quelle: <a class="link" href="https://www.lotto-bayern.de" target="_blank" rel="noreferrer">lotto-bayern.de</a></div>
  </footer>
</div>

<script>
(function(){
  "use strict";

  const ARCHIVE_URL = "https://www.lotto-bayern.de/static/gamebroker_2/de/download_files/archiv_eurojackpot.zip";

  const app = {
    draws: [],   // {date: "YYYY-MM-DD" | null, main:[5], euro:[2]}
    generated: [],
    stats: null
  };

  const el = id => document.getElementById(id);

  function setStatus(targetId,msg,type,loading){
    const n = el(targetId);
    if(!n) return;
    const cls = type==="ok"?"ok":type==="err"?"err":type==="warn"?"warn":"";
    const icon = type==="ok"?"‚úÖ":type==="err"?"‚ùå":type==="warn"?"‚ö†Ô∏è":"‚ÑπÔ∏è";
    n.innerHTML = (loading?'<span class="loader"></span>':'')+`<span class="${cls}">${icon} ${msg}</span>`;
  }

  /* ===== JSZip & Proxy-Download ========================================= */

  async function ensureJSZip(){
    if(window.JSZip) return true;
    const cdns = [
      "https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js",
      "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js",
      "https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"
    ];
    for(const src of cdns){
      try{
        await new Promise((resolve,reject)=>{
          const s=document.createElement("script");
          s.src=src; s.async=true;
          s.onload=()=>resolve();
          s.onerror=()=>reject();
          document.head.appendChild(s);
        });
        if(window.JSZip) return true;
      }catch(e){}
    }
    return !!window.JSZip;
  }

  async function fetchWithProxies(url){
    const trials = [
      url,
      "https://cors.isomorphic-git.org/"+url,
      "https://api.allorigins.win/raw?url="+encodeURIComponent(url),
      "https://thingproxy.freeboard.io/fetch/"+url,
      "https://corsproxy.io/?"+encodeURIComponent(url)
    ];
    let lastErr = null;
    for(const u of trials){
      try{
        console.log("[Archiv] Versuche URL:", u);
        const res = await fetch(u);
        if(!res.ok) throw new Error("HTTP "+res.status);
        const ct = (res.headers.get("content-type") || "").toLowerCase();
        if(ct.includes("zip") || u.toLowerCase().endsWith(".zip")){
          const ok = await ensureJSZip();
          if(!ok) throw new Error("JSZip konnte nicht geladen werden.");
          const blob = await res.blob();
          const zip = await JSZip.loadAsync(blob);
          const entries = Object.values(zip.files);
          let entry = entries.find(f=>/\.txt$/i.test(f.name)) ||
                      entries.find(f=>/\.csv$/i.test(f.name)) ||
                      entries[0];
          if(!entry) throw new Error("Keine Datei im ZIP gefunden.");
          console.log("[Archiv] Nutze Datei aus ZIP:", entry.name);
          return await entry.async("string");
        }else{
          console.log("[Archiv] Kein ZIP, lese als Text.");
          return await res.text();
        }
      }catch(e){
        console.warn("[Archiv] Fehler mit", u, e);
        lastErr = e;
      }
    }
    throw lastErr || new Error("Download √ºber alle Proxys fehlgeschlagen.");
  }

  /* ===== Parsing ========================================================= */

  function parseArchiveText(txt){
    txt = txt.replace(/^\uFEFF/,"");
    const lines = txt.replace(/\r\n?/g,"\n").split("\n").map(l=>l.trim()).filter(Boolean);
    const draws = [];

    for(const line of lines){
      if(/tag\s+monat\s+jahr/i.test(line)) continue;          // Kopfzeile
      if(/ZahlA1/i.test(line)) continue;

      const nums = (line.match(/\d+/g)||[]).map(Number);
      if(nums.length < 7) continue;

      // Lotto-Bayern-Format: Tag Monat Jahr + 5 Hauptzahlen + 2 Eurozahlen
      // -> Wir nutzen immer die letzten 7 Zahlen als 5 Haupt + 2 Euro
      const last7 = nums.slice(-7);
      if(last7.length !== 7) continue;
      const main = last7.slice(0,5);
      const euro = last7.slice(5,7);

      if(!main.every(n=>n>=1 && n<=50)) continue;
      if(!euro.every(n=>n>=1 && n<=12)) continue;

      main.sort((a,b)=>a-b);
      euro.sort((a,b)=>a-b);

      // Datum aus den ersten 3 Zahlen (Tag, Monat, Jahr)
      let date = null;
      if(nums.length >= 3){
        const d = nums[0], m = nums[1], y = nums[2];
        if(y >= 2000 && y <= 2100 && m>=1 && m<=12 && d>=1 && d<=31){
          const dt = new Date(y, m-1, d);
          if(!isNaN(dt.getTime())){
            date = dt.toISOString().slice(0,10);
          }
        }
      }

      draws.push({date, main, euro});
    }

    if(!draws.length) throw new Error("Keine g√ºltigen Ziehungen im Archiv gefunden.");

    draws.sort((a,b)=>{
      if(!a.date && !b.date) return 0;
      if(!a.date) return -1;
      if(!b.date) return 1;
      return a.date.localeCompare(b.date);
    });

    app.draws = draws;
    app.stats = null;
    console.log("[Archiv] Parsed draws:", draws.length);
  }

  async function loadArchiveRemote(){
    setStatus("archiveStatus","Lade Archiv (ZIP, mehrere Proxys)‚Ä¶","info",true);
    try{
      const text = await fetchWithProxies(ARCHIVE_URL);
      parseArchiveText(text);
      setStatus("archiveStatus","Archiv geladen: "+app.draws.length+" Ziehungen.","ok");
      setStatus("statsStatus","Archiv geladen. W√§hle einen Zeitraum und klicke auf ‚ÄûStatistik berechnen‚Äú.","ok");
    }catch(e){
      console.error(e);
      setStatus("archiveStatus","Archiv konnte nicht automatisch geladen werden: "+e.message,"err");
    }
  }

  function setupFileInput(){
    const input = el("fileInput");
    input.addEventListener("change", async ev=>{
      const file = ev.target.files && ev.target.files[0];
      if(!file) return;
      const name = file.name.toLowerCase();
      try{
        if(name.endsWith(".txt") || name.endsWith(".csv")){
          const text = await file.text();
          parseArchiveText(text);
        }else if(name.endsWith(".zip")){
          setStatus("archiveStatus","ZIP wird entpackt‚Ä¶","info",true);
          const ok = await ensureJSZip();
          if(!ok) throw new Error("JSZip-Bibliothek konnte nicht geladen werden.");
          const buf = await file.arrayBuffer();
          const zip = await JSZip.loadAsync(buf);
          const entries = Object.values(zip.files);
          let entry = entries.find(f=>/\.txt$/i.test(f.name)) ||
                      entries.find(f=>/\.csv$/i.test(f.name)) ||
                      entries[0];
          if(!entry) throw new Error("Keine TXT/CSV in der ZIP gefunden.");
          const text = await entry.async("string");
          parseArchiveText(text);
        }else{
          throw new Error("Dateityp nicht unterst√ºtzt.");
        }
        setStatus("archiveStatus","Archiv geladen: "+app.draws.length+" Ziehungen.","ok");
        setStatus("statsStatus","Archiv geladen. W√§hle einen Zeitraum und klicke auf ‚ÄûStatistik berechnen‚Äú.","ok");
      }catch(e){
        console.error(e);
        setStatus("archiveStatus","Fehler beim Lesen der Datei: "+e.message,"err");
      }
    });
  }

  /* ===== Statistik ======================================================= */

  function computeStats(){
    if(!app.draws.length){
      setStatus("statsStatus","Bitte zuerst das Archiv laden.","err");
      el("statsTableWrap").style.display="none";
      el("rangeTableWrap").style.display="none";
      return;
    }
    const n = Number(el("statsRange").value)||12;
    const subset = app.draws.slice(-Math.min(n,app.draws.length));
    const mainFreq = Array(51).fill(0);
    const ranges = [0,0,0,0,0];
    subset.forEach(d=>{
      d.main.forEach(m=>{
        mainFreq[m]++;
        const idx = Math.floor((m-1)/10);
        ranges[idx]++;
      });
    });
    const totalMain = subset.length*5;
    const arr = [];
    for(let i=1;i<=50;i++) arr.push({num:i,count:mainFreq[i]});
    arr.sort((a,b)=>a.count-b.count);
    const coldCut = Math.ceil(50*0.2), hotCut = Math.floor(50*0.8);
    const cold = new Set(arr.slice(0,coldCut).map(x=>x.num));
    const hot  = new Set(arr.slice(hotCut).map(x=>x.num));

    app.stats = {mainFreq,ranges,totalMain,subset,hot,cold};

    const body = el("statsBody");
    body.innerHTML="";
    for(let i=1;i<=50;i++){
      const c = mainFreq[i];
      const pct = totalMain ? (c/totalMain*100) : 0;
      let cls="",lbl="neutral";
      if(hot.has(i)){cls="hot";lbl="hot";}
      else if(cold.has(i)){cls="cold";lbl="cold";}
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${i}</td><td>${c}</td><td>${pct.toFixed(1)} %</td><td><span class="pill-mini ${cls}">${lbl}</span></td>`;
      body.appendChild(tr);
    }

    const labels = ["1‚Äì10","11‚Äì20","21‚Äì30","31‚Äì40","41‚Äì50"];
    const rangeBody = el("rangeBody");
    rangeBody.innerHTML="";
    const totalRange = ranges.reduce((a,b)=>a+b,0)||1;
    ranges.forEach((c,idx)=>{
      const pct = c/totalRange*100;
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${labels[idx]}</td><td>${c}</td><td>${pct.toFixed(1)} %</td>`;
      rangeBody.appendChild(tr);
    });

    el("statsTableWrap").style.display="block";
    el("rangeTableWrap").style.display="block";
    setStatus("statsStatus","Statistik f√ºr die letzten "+subset.length+" Ziehungen berechnet.","ok");
  }

  /* ===== Generator ======================================================= */

  function weightedPick(weights){
    let sum = 0;
    for(let i=1;i<weights.length;i++) sum += Math.max(0,weights[i]);
    if(sum<=0) return null;
    let r = Math.random()*sum;
    for(let i=1;i<weights.length;i++){
      r -= Math.max(0,weights[i]);
      if(r<=0) return i;
    }
    return null;
  }

  function countIntersection(a,b){
    const s = new Set(a); let c=0;
    for(const x of b) if(s.has(x)) c++;
    return c;
  }

  function variantEqual(a,b){
    if(a.main.length!==b.main.length || a.euro.length!==b.euro.length) return false;
    for(let i=0;i<a.main.length;i++) if(a.main[i]!==b.main[i]) return false;
    for(let i=0;i<a.euro.length;i++) if(a.euro[i]!==b.euro[i]) return false;
    return true;
  }

  function isDiverse(v,list){
    for(const o of list){
      const inter = countIntersection(v.main,o.main);
      if(inter>=4) return false;
    }
    return true;
  }

  function ensureStatsForGen(){
    if(app.stats) return app.stats;
    if(!app.draws.length) return null;
    const subset = app.draws.slice(-Math.min(60,app.draws.length));
    const mainFreq = Array(51).fill(0);
    const ranges=[0,0,0,0,0];
    subset.forEach(d=>{
      d.main.forEach(m=>{
        mainFreq[m]++;
        const idx=Math.floor((m-1)/10);
        ranges[idx]++;
      });
    });
    const totalMain=subset.length*5;
    const arr=[];
    for(let i=1;i<=50;i++) arr.push({num:i,count:mainFreq[i]});
    arr.sort((a,b)=>a.count-b.count);
    const coldCut=Math.ceil(50*0.2), hotCut=Math.floor(50*0.8);
    const cold=new Set(arr.slice(0,coldCut).map(x=>x.num));
    const hot=new Set(arr.slice(hotCut).map(x=>x.num));
    app.stats={mainFreq,ranges,totalMain,subset,hot,cold};
    return app.stats;
  }

  function generateSingle(mainW,euroW,includeEuro,forceUniform){
    const mW = mainW.slice(), eW = euroW.slice();
    if(forceUniform){
      for(let i=1;i<mW.length;i++) mW[i]=1;
      for(let i=1;i<eW.length;i++) eW[i]=1;
    }
    const main=[];
    for(let k=0;k<5;k++){
      const n = weightedPick(mW); if(!n) return null;
      main.push(n); mW[n]=0;
    }
    main.sort((a,b)=>a-b);
    const euro=[];
    if(includeEuro){
      for(let k=0;k<2;k++){
        const e = weightedPick(eW); if(!e) return null;
        euro.push(e); eW[e]=0;
      }
      euro.sort((a,b)=>a-b);
    }
    return {main,euro};
  }

  function renderGenerated(){
    const body = el("genBody");
    body.innerHTML="";
    app.generated.forEach((v,idx)=>{
      const tr = document.createElement("tr");
      const mainHtml = v.main.map(n=>`<span class="ball">${n}</span>`).join(" ");
      const euroHtml = v.euro && v.euro.length ? v.euro.map(n=>`<span class="ball euro">${n}</span>`).join(" ") : "‚Äì";
      tr.innerHTML = `<td>${idx+1}</td><td><div class="balls">${mainHtml}</div></td><td><div class="balls">${euroHtml}</div></td>`;
      body.appendChild(tr);
    });
    el("genTableWrap").style.display = app.generated.length?"block":"none";
    el("genExportRow").style.display = app.generated.length?"flex":"none";
  }

  function generateVariants(){
    const count = Math.max(1,Math.min(500,Number(el("numVariants").value)||1));
    el("numVariants").value = count;
    if(!app.draws.length){
      setStatus("genStatus","Bitte zuerst das Archiv laden.","err");
      return;
    }
    const includeEuro = el("genIncludeEuro").checked;
    const useStats    = el("genUseStats").checked;
    const noDup       = el("genNoDup").checked;
    const maxDiff     = el("genMaxDiff").checked;

    setStatus("genStatus","Varianten werden generiert‚Ä¶","info",true);

    const stats = useStats ? ensureStatsForGen() : null;
    const mainW = Array(51).fill(1);
    const euroW = Array(13).fill(1);
    if(stats && useStats){
      const totalRange = stats.ranges.reduce((a,b)=>a+b,0)||1;
      for(let n=1;n<=50;n++){
        if(stats.hot.has(n)) mainW[n]*=1.5;
        if(stats.cold.has(n)) mainW[n]*=0.7;
        const idx = Math.floor((n-1)/10);
        const share = stats.ranges[idx]/totalRange;
        mainW[n]*=0.5+share*1.5;
      }
    }

    const variants = [];
    const maxAttempts = 40;
    for(let i=0;i<count;i++){
      let v=null, tries=0;
      while(!v && tries<maxAttempts){
        tries++;
        v = generateSingle(mainW,euroW,includeEuro,false);
        if(!v) continue;
        if(noDup && variants.some(o=>variantEqual(o,v))){v=null;continue;}
        if(maxDiff && !isDiverse(v,variants)){v=null;continue;}
      }
      if(!v) v = generateSingle(mainW,euroW,includeEuro,true);
      variants.push(v);
    }
    app.generated = variants;
    renderGenerated();
    setStatus("genStatus","Es wurden "+variants.length+" Varianten erzeugt.","ok");
  }

  function exportVariants(type){
    if(!app.generated.length) return;
    if(type==="txt"){
      const lines = app.generated.map(v=>{
        const main = v.main.join(" ");
        const euro = v.euro && v.euro.length ? " | "+v.euro.join(" ") : "";
        return main+euro;
      });
      const blob = new Blob([lines.join("\n")],{type:"text/plain;charset=utf-8"});
      triggerDownload(blob,"eurojackpot_varianten.txt");
    }else{
      const lines = ["Z1;Z2;Z3;Z4;Z5;E1;E2"];
      app.generated.forEach(v=>{
        const arr=[...v.main];
        if(v.euro && v.euro.length) arr.push(...v.euro); else arr.push("","");
        lines.push(arr.join(";"));
      });
      const blob = new Blob([lines.join("\n")],{type:"text/csv;charset=utf-8"});
      triggerDownload(blob,"eurojackpot_varianten.csv");
    }
  }

  function triggerDownload(blob,name){
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href=url; a.download=name;
    document.body.appendChild(a); a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  /* ===== Analyse ========================================================= */

  function parseManualVariants(text){
    const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
    const res = [];
    for(const line of lines){
      const nums = (line.match(/\d+/g)||[]).map(Number);
      if(nums.length<5) continue;
      const arr = nums.slice(-7);
      const main = arr.slice(0,5);
      const euro = arr.slice(5,7);
      if(!main.every(n=>n>=1 && n<=50)) continue;
      if(euro.length && !euro.every(e=>e>=1 && e<=12)) continue;
      main.sort((a,b)=>a-b);
      euro.sort((a,b)=>a-b);
      res.push({main,euro});
    }
    return res;
  }

  function analyze(){
    if(!app.draws.length){
      setStatus("analysisStatus","Bitte zuerst das Archiv laden.","err");
      el("analysisWrap").style.display="none";
      return;
    }
    const src = Array.from(document.getElementsByName("vsource")).find(r=>r.checked)?.value || "gen";
    let variants = [];
    if(src==="gen"){
      if(!app.generated.length){
        setStatus("analysisStatus","Keine generierten Varianten vorhanden.","err");
        el("analysisWrap").style.display="none";
        return;
      }
      variants = app.generated.slice();
    }else{
      const text = el("manualInput").value.trim();
      if(!text){
        setStatus("analysisStatus","Bitte Varianten in das Textfeld eintragen.","err");
        el("analysisWrap").style.display="none";
        return;
      }
      variants = parseManualVariants(text);
      if(!variants.length){
        setStatus("analysisStatus","Keine g√ºltigen Varianten in der Eingabe gefunden.","err");
        el("analysisWrap").style.display="none";
        return;
      }
    }

    const includeEuro = el("analysisIncludeEuro").checked;
    setStatus("analysisStatus","Analyse l√§uft‚Ä¶","info",true);

    const body = el("analysisBody");
    body.innerHTML = "";

    variants.forEach((v,idx)=>{
      let h3=0,h4=0,h5=0;
      const euroMap = {};
      app.draws.forEach(d=>{
        const mh = countIntersection(v.main,d.main);
        if(mh<3) return;
        if(mh===3) h3++; else if(mh===4) h4++; else if(mh===5) h5++;
        if(includeEuro && v.euro && v.euro.length){
          const eh = countIntersection(v.euro,d.euro);
          const key = mh+"+"+eh;
          euroMap[key]=(euroMap[key]||0)+1;
        }
      });
      let euroTxt = "‚Äì";
      if(includeEuro){
        const parts = Object.keys(euroMap).sort((a,b)=>{
          const [am,ae]=a.split("+").map(Number);
          const [bm,be]=b.split("+").map(Number);
          if(am!==bm) return bm-am;
          return be-ae;
        }).map(k=>`${k} (${euroMap[k]}√ó)`);
        euroTxt = parts.length?parts.join(", "):"‚Äì";
      }
      const mainStr = v.main.join(" ");
      const euroStr = v.euro && v.euro.length ? " | "+v.euro.join(" ") : "";
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${idx+1}</td><td>${mainStr}${euroStr}</td><td>${h3}</td><td>${h4}</td><td>${h5}</td><td>${euroTxt}</td>`;
      body.appendChild(tr);
    });

    el("analysisWrap").style.display="block";
    setStatus("analysisStatus","Analyse f√ºr "+variants.length+" Varianten abgeschlossen.","ok");
  }

  /* ===== Init ============================================================ */

  function initDate(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    el("drawDate").value = `${yyyy}-${mm}-${dd}`;
  }

  function init(){
    initDate();
    setupFileInput();

    el("btnLoadRemote").addEventListener("click",loadArchiveRemote);
    el("btnStats").addEventListener("click",computeStats);
    el("btnGen").addEventListener("click",generateVariants);
    el("btnExportTxt").addEventListener("click",()=>exportVariants("txt"));
    el("btnExportCsv").addEventListener("click",()=>exportVariants("csv"));
    el("btnAnalyze").addEventListener("click",analyze);
    document.getElementsByName("vsource").forEach(r=>{
      r.addEventListener("change",()=>{
        const manual = Array.from(document.getElementsByName("vsource")).find(x=>x.checked)?.value==="manual";
        el("manualRow").style.display = manual?"block":"none";
      });
    });
    el("scrollGen").addEventListener("click",()=>{
      document.getElementById("generatorSection").scrollIntoView({behavior:"smooth",block:"start"});
    });
  }

  document.addEventListener("DOMContentLoaded",init);
})();
</script>
</body>
</html>